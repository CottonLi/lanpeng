<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lanpeng.data.mapper.AlarmMapper">

    <resultMap type="Alarm" id="AlarmResult">
        <id     property="id"                    column="id" />
        <result property="alarmRuleId"           column="alarmRuleId" />
        <result property="alarmRuleVersion"      column="alarmRuleVersion" />
        <result property="object"                column="object" />
        <result property="level"                 column="level" />
        <result property="content"               column="content" />
        <result property="status"                column="status" />
        <result property="occurTime"             column="occurTime" />
        <result property="acknowledgeBy"         column="acknowledgeBy" />
        <result property="acknowledgeTime"       column="acknowledgeTime" />
        <result property="clearBy"               column="clearBy" />
        <result property="clearTime"             column="clearTime" />
        <result property="closeBy"               column="closeBy"     />
        <result property="closeTime"             column="closeTime"     />
        <association property="alarmRule"        javaType="AlarmRule"   resultMap="AAlarmRuleResult" />
    </resultMap>

    <resultMap type="AlarmRule" id="AAlarmRuleResult">
        <id     property="id"                    column="arid" />
        <result property="code"                  column="code" />
        <result property="version"               column="version" />
        <result property="dataItemId"            column="dataItemId" />
        <result property="dataItemCode"          column="dataItemCode" />
        <result property="dataItemType"          column="dataItemType" />
        <result property="operator"              column="operator" />
        <result property="operator1"             column="operator1" />
        <result property="operator2"             column="operator2" />
        <result property="continuousTime"        column="continuousTime" />
        <result property="level"                 column="arlevel" />
        <result property="description"           column="description" />
        <association property="dataItem"         javaType="DataItem"   resultMap="ADataItemResult" />
    </resultMap>

    <resultMap type="DataItem" id="ADataItemResult">
        <id     property="id"             column="diid"  />
        <result property="code"           column="dicode"/>
        <result property="dataName"       column="dataName"/>
        <result property="dataType"       column="dataType"/>
        <result property="dataPrecision"  column="dataPrecision"/>
        <result property="unit"           column="unit"/>
        <result property="nodeType"       column="nodeType"/>
        <result property="nodeId"         column="nodeId"/>
        <result property="mappingField"   column="mappingField"/>
        <result property="store_flag"     column="store_flag"/>
        <result property="transfer_flag"  column="transfer_flag"/>
        <result property="display_flag"   column="display_flag"/>
        <result property="control_flag"   column="control_flag"/>
        <result property="alarm_flag"     column="alarm_flag"/>
    </resultMap>

    <sql id="selectAlarmVo">
        select a.id, a.alarmRuleId, a.alarmRuleVersion, a.object,a.level,a.content,a.status,
               a.occurTime,a.acknowledgeBy,a.acknowledgeTime,a.clearBy,a.clearTime,
               a.closeBy,a.closeTime,
               ar.id as arid,ar.code,ar.version,ar.dataItemId,ar.dataItemCode,ar.dataItemType,
               ar.operator,ar.operator1,ar.operator2,ar.continuousTime,
               ar.level as arlevel,ar.description,
               di.id as diid,di.code as dicode,di.dataName,di.dataType,di.dataPrecision,di.unit,di.nodeType,di.nodeId,di.mappingField,
               di.store_flag,di.transfer_flag,di.display_flag,di.control_flag,di.alarm_flag
        from alarm a
                 left join alarmrule ar on a.alarmRuleId = ar.id
                 left join dataitem di on ar.dataItemId = di.id
    </sql>

    <select id="selectAlarmList" parameterType="AlarmCondition" resultMap="AlarmResult">
        <include refid="selectAlarmVo"/>
        where
        <if test="ac.status != null and ac.status != ''"> a.status=#{ac.status} and </if>
        <if test="ac.level != null"> a.level=#{ac.level} and </if>
        <if test="ac.startTime != null"> a.occurTime<![CDATA[ >= ]]>#{ac.startTime} and </if>
        <if test="ac.stopTime != null"> a.occurTime<![CDATA[ <= ]]>#{ac.stopTime} and </if>
        1=1
    </select>

    <insert id="insertAlarm" parameterType="Alarm">
        insert into alarm (alarmRuleId,alarmRuleVersion,object,level,content,occurTime
        )values(#{a.alarmRuleId},#{a.alarmRuleVersion},#{a.object},#{a.level},#{a.content},sysdate())
    </insert>

    <update id="changeAlarmStatus" parameterType="Alarm">
        update alarm
        <set>
            <if test='a.status == "1"'>acknowledgeTime = sysdate(),status = #{a.status}</if>
            <if test='a.status == "2"'>clearTime = sysdate(),status = #{a.status}</if>
            <if test='a.status == "3"'>closeTime = sysdate(),status = #{a.status}</if>
        </set>
        where id = #{a.id}
    </update>

    <delete id="deleteAlarmById" parameterType="Long">
        delete from alarm where id = #{aid}
    </delete>

</mapper>